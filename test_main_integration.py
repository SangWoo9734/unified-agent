"""
Main.py Integration Test

main.pyì˜ Level2Agent í†µí•©ì„ í…ŒìŠ¤íŠ¸í•©ë‹ˆë‹¤.
"""

import os
import tempfile
from pathlib import Path

# ìƒ˜í”Œ ë¦¬í¬íŠ¸
SAMPLE_REPORT = """# Multi-Product Analysis Report
ìƒì„±ì¼: 2026-01-13
ë¶„ì„ í”„ë¡œë•íŠ¸: QR Generator
ë°ì´í„° ê¸°ê°„: 2026-01-06 ~ 2026-01-13

---

## ë¶„ì„ ê°œìš”

ë³¸ ë¦¬í¬íŠ¸ëŠ” QR Generator í”„ë¡œë•íŠ¸ì˜ SEO ë¶„ì„ ê²°ê³¼ì…ë‹ˆë‹¤.

## High Priority Actions

1. **[QR Generator]** Update meta title to "QR Code Generator - Free & Fast"

- File: `src/app/layout.tsx`
- Expected Impact: ê²€ìƒ‰ ë…¸ì¶œ 20% ì¦ê°€ ì˜ˆìƒ

2. **[QR Generator]** Update meta description to "Create QR codes instantly. Free, fast, and easy to use."

- File: `src/app/layout.tsx`
- Expected Impact: CTR 15% ì¦ê°€ ì˜ˆìƒ

## ê²°ë¡ 

ì´ 2ê°œì˜ High Priority ì•¡ì…˜ì´ ì œì•ˆë˜ì—ˆìŠµë‹ˆë‹¤.

---

*Generated by Unified Multi-Product Agent*
"""


def test_main_integration():
    """main.pyì˜ Level2Agent í†µí•© í…ŒìŠ¤íŠ¸"""

    print("=== Main.py Integration í…ŒìŠ¤íŠ¸ ===\n")

    # Level2Agentë¥¼ ì§ì ‘ í…ŒìŠ¤íŠ¸ (main.pyì˜ ì¼ë¶€ë¥¼ ì‹œë®¬ë ˆì´ì…˜)
    from core.level2_agent import Level2Agent

    # ì„ì‹œ ë¦¬í¬íŠ¸ íŒŒì¼ ìƒì„±
    with tempfile.TemporaryDirectory() as temp_dir:
        temp_path = Path(temp_dir)

        report_path = temp_path / "test_report.md"
        report_path.write_text(SAMPLE_REPORT, encoding="utf-8")

        print(f"ğŸ“„ í…ŒìŠ¤íŠ¸ ë¦¬í¬íŠ¸ ìƒì„±: {report_path}\n")

        # Level2Agent ì´ˆê¸°í™” (Dry-run ëª¨ë“œ)
        agent = Level2Agent(
            workspace_root=".",
            dry_run=True
        )

        # ë¦¬í¬íŠ¸ ì²˜ë¦¬ (main.pyì˜ 8ë‹¨ê³„ ì‹œë®¬ë ˆì´ì…˜)
        result = agent.process_report(str(report_path))

        # ê²°ê³¼ ì¶œë ¥ (main.pyì™€ ë™ì¼í•œ í¬ë§·)
        print("\n=== ì²˜ë¦¬ ê²°ê³¼ (main.py í¬ë§·) ===\n")

        if result['success']:
            print(f"âœ… Level 2 Agent ì‹¤í–‰ ì™„ë£Œ!")
            print(f"   ì¶”ì¶œëœ ì•¡ì…˜: {result['actions_extracted']}ê°œ")
            print(f"   ì•ˆì „í•œ ì•¡ì…˜: {result['actions_safe']}ê°œ")
            print(f"   ì‹¤í–‰ëœ ì•¡ì…˜: {result['actions_executed']}ê°œ")

            if result.get('pr_url'):
                print(f"\nğŸ‰ GitHub PR ìƒì„± ì™„ë£Œ:")
                print(f"   {result['pr_url']}")
            else:
                print(f"\nâš ï¸  PRì„ ìƒì„±í•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤ (Dry-run ëª¨ë“œ)")
        else:
            print(f"âŒ Level 2 Agent ì‹¤í–‰ ì‹¤íŒ¨: {result.get('error', 'Unknown error')}")

        # ê²€ì¦
        assert result['success'] is True, "ì²˜ë¦¬ ì‹¤íŒ¨"
        assert result['actions_extracted'] >= 2, "ì•¡ì…˜ ì¶”ì¶œ ì‹¤íŒ¨"
        assert result['actions_safe'] >= 2, "ì•ˆì „í•œ ì•¡ì…˜ í•„í„°ë§ ì‹¤íŒ¨"
        assert result['actions_executed'] >= 2, "ì•¡ì…˜ ì‹¤í–‰ ì‹¤íŒ¨"

        print("\nâœ… Main.py Integration í…ŒìŠ¤íŠ¸ í†µê³¼!\n")


def test_env_var_check():
    """í™˜ê²½ë³€ìˆ˜ ì²´í¬ ë¡œì§ í…ŒìŠ¤íŠ¸"""

    print("=== í™˜ê²½ë³€ìˆ˜ ì²´í¬ í…ŒìŠ¤íŠ¸ ===\n")

    # ENABLE_AUTO_PR ì²´í¬ (main.py ë¡œì§)
    enable_auto_pr = os.getenv('ENABLE_AUTO_PR', 'false').lower() == 'true'

    print(f"ENABLE_AUTO_PR: {os.getenv('ENABLE_AUTO_PR', 'false')}")
    print(f"Auto PR í™œì„±í™”: {enable_auto_pr}")

    if enable_auto_pr:
        print("âœ… Level 2 Agentê°€ í™œì„±í™”ë©ë‹ˆë‹¤.")

        # GITHUB_TOKEN ì²´í¬
        github_token = os.getenv('GITHUB_TOKEN')
        if github_token:
            print(f"âœ… GITHUB_TOKEN: {github_token[:10]}... (ì„¤ì •ë¨)")
        else:
            print("âš ï¸  GITHUB_TOKENì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.")
    else:
        print("ğŸ’¡ Tip: ENABLE_AUTO_PR=trueë¡œ ì„¤ì •í•˜ë©´ ìë™ìœ¼ë¡œ PRì„ ìƒì„±í•©ë‹ˆë‹¤.")

    print("\nâœ… í™˜ê²½ë³€ìˆ˜ ì²´í¬ í…ŒìŠ¤íŠ¸ ì™„ë£Œ!\n")


def test_report_format():
    """ë¦¬í¬íŠ¸ í¬ë§· í˜¸í™˜ì„± í…ŒìŠ¤íŠ¸"""

    print("=== ë¦¬í¬íŠ¸ í¬ë§· í˜¸í™˜ì„± í…ŒìŠ¤íŠ¸ ===\n")

    # main.pyê°€ ìƒì„±í•˜ëŠ” ë¦¬í¬íŠ¸ í¬ë§·ì´ Level2Agentì™€ í˜¸í™˜ë˜ëŠ”ì§€ í™•ì¸
    # main.py ë¦¬í¬íŠ¸ í¬ë§·:
    # - í—¤ë”: "# Multi-Product Analysis Report"
    # - ë³¸ë¬¸: Comparative Analyzerê°€ ìƒì„±
    # - í‘¸í„°: "*Generated by Unified Multi-Product Agent*"

    print("âœ“ main.py ë¦¬í¬íŠ¸ í¬ë§·:")
    print("  - í—¤ë”: # Multi-Product Analysis Report")
    print("  - ë¶„ì„ ì„¹ì…˜: ## High Priority Actions")
    print("  - í‘¸í„°: *Generated by...*")
    print()

    print("âœ“ Level2Agent ìš”êµ¬ì‚¬í•­:")
    print("  - ActionExtractorëŠ” '## High Priority Actions' ì„¹ì…˜ì„ ì°¾ìŒ")
    print("  - ì•¡ì…˜ í¬ë§·: '1. **[Product]** Description'")
    print()

    print("âœ… í¬ë§· í˜¸í™˜ì„±: OK")
    print("   main.py ë¦¬í¬íŠ¸ê°€ Level2Agentì™€ í˜¸í™˜ë©ë‹ˆë‹¤.\n")


if __name__ == "__main__":
    test_main_integration()
    test_env_var_check()
    test_report_format()

    print("ğŸ‰ ëª¨ë“  Main.py Integration í…ŒìŠ¤íŠ¸ í†µê³¼!")
